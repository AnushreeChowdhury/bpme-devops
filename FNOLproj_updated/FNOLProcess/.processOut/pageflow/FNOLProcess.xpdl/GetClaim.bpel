<?xml version="1.0" encoding="UTF-8"?>
<bpws:process exitOnStandardFault="no" name="GetClaim"
    suppressJoinFailure="yes" tibex:bxVersion="11.0.0"
    tibex:dataFieldDescriptorClass="com.example.fnolprocess.FNOLProcess.GetClaim"
    tibex:dataFieldDescriptorScript="process-js/FNOLProcess/GetClaim/GetClaim.js"
    tibex:explicitCompensation="yes"
    tibex:xpdlId="_TCcSkPRnEeuR8o7qyugDXg"
    xmlns:bpws="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:tibex="http://www.tibco.com/bpel/2007/extensions" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
    <tibex:VariableDescriptor type="PersistentBatching">
        <task name="_BX_SPOutput_GetClaimforPolicy">
            <startingVariables>
                <variable>ClaimRef</variable>
                <variable>ClaimId</variable>
                <variable>Claim</variable>
            </startingVariables>
        </task>
        <task name="AttempttoGetClaim">
            <startingVariables>
                <variable>ClaimRef</variable>
                <variable>debug</variable>
                <variable>ClaimId</variable>
                <variable>Claim</variable>
            </startingVariables>
        </task>
        <task name="VerifyClaim">
            <startingVariables>
                <variable>PolicyHolder</variable>
                <variable>ClaimPolicyHolder</variable>
                <variable>PolicyHolderRefs</variable>
                <variable>ClaimRef</variable>
                <variable>debug</variable>
                <variable>PolicyRefs</variable>
                <variable>PolicyHolderRef</variable>
            </startingVariables>
        </task>
        <task name="ClaimIdisnotvalid">
            <startingVariables>
                <variable>ClaimId</variable>
            </startingVariables>
        </task>
        <task name="_BX_SPInput_GetClaimforPolicy">
            <startingVariables>
                <variable>PolicyRef</variable>
            </startingVariables>
        </task>
    </tibex:VariableDescriptor>
    <bpws:documentation>*** Generated by TIBCO Business Studio.</bpws:documentation>
    <bpws:variables>
        <bpws:variable name="PolicyRef"
            tibex:classRef="com.fnoldata.Policy" tibex:parameter="in" tibex:xpdlId="_VGVc_PRnEeuR8o7qyugDXg"/>
        <bpws:variable name="Claim" tibex:class="com.fnoldata.Claim"
            tibex:classVersion="1" tibex:parameter="out" tibex:xpdlId="_VGVc__RnEeuR8o7qyugDXg"/>
        <bpws:variable name="ClaimRef"
            tibex:classRef="com.fnoldata.Claim" tibex:parameter="out" tibex:xpdlId="_q5PIkPRnEeuR8o7qyugDXg"/>
        <bpws:variable name="ClaimId" tibex:parameter="in"
            tibex:xpdlId="_avbPcPXzEeuVSY3wUmTw-w" type="xsd:string"/>
        <bpws:variable name="PolicyHolder"
            tibex:class="com.fnoldata.Policyholder"
            tibex:classVersion="1" tibex:parameter="in" tibex:xpdlId="_k62-4Pj3EeubGpJIKV_AxA"/>
        <bpws:variable name="PolicyRefs" tibex:array="yes"
            tibex:classRef="com.fnoldata.Policy" tibex:xpdlId="_KcpIAPX0EeuVSY3wUmTw-w"/>
        <bpws:variable name="PolicyHolderRefs" tibex:array="yes"
            tibex:classRef="com.fnoldata.Policyholder" tibex:xpdlId="_PKU_IPX0EeuVSY3wUmTw-w"/>
        <bpws:variable name="ClaimPolicyHolder"
            tibex:class="com.fnoldata.Policyholder"
            tibex:classVersion="1" tibex:xpdlId="_voIZ4Pj3EeubGpJIKV_AxA"/>
        <bpws:variable name="PolicyHolderRef"
            tibex:classRef="com.fnoldata.Policyholder" tibex:xpdlId="_KB6KAPj4EeubGpJIKV_AxA"/>
        <bpws:variable name="debug"
            tibex:xpdlId="_2tzo0PkHEeubGpJIKV_AxA" type="xsd:string"/>
    </bpws:variables>
    <bpws:extensions>
        <bpws:extension mustUnderstand="yes" namespace="http://www.tibco.com/bpel/2007/extensions"/>
    </bpws:extensions>
    <bpws:eventHandlers/>
    <bpws:flow name="_BX_flow_7IoKQPn3Eeuuh9nQQEuk5Q">
        <bpws:links>
            <bpws:link
                name="_AFLMoPXuEeuVSY3wUmTw-w to GetClaimforPolicy" tibex:xpdlId="_TCdgtfRnEeuR8o7qyugDXg"/>
            <bpws:link name="ClaimIdspecified" tibex:xpdlId="_ZJu2QfXuEeuVSY3wUmTw-w"/>
            <bpws:link name="_BC3KoPXzEeuVSY3wUmTw-w to End" tibex:xpdlId="_W35hMPRnEeuR8o7qyugDXg"/>
            <bpws:link name="VerifyClaim to _Y8PvsPX1EeuVSY3wUmTw-w" tibex:xpdlId="_Tt1-0Pa-EeubGpJIKV_AxA"/>
            <bpws:link
                name="ClaimIdisnotvalid to _BC3KoPXzEeuVSY3wUmTw-w" tibex:xpdlId="_spPewfX1EeuVSY3wUmTw-w"/>
            <bpws:link name="Start to _AFLMoPXuEeuVSY3wUmTw-w" tibex:xpdlId="_AFLzsPXuEeuVSY3wUmTw-w"/>
            <bpws:link name="AttempttoGetClaim to VerifyClaim" tibex:xpdlId="_PIMCU_a-EeubGpJIKV_AxA"/>
            <bpws:link
                name="_Y8PvsPX1EeuVSY3wUmTw-w to ClaimIdisnotvalid" tibex:xpdlId="_KreqsPXzEeuVSY3wUmTw-w"/>
            <bpws:link name="Claimisvalid" tibex:xpdlId="_efEfEPX1EeuVSY3wUmTw-w"/>
            <bpws:link
                name="GetClaimforPolicy to _BC3KoPXzEeuVSY3wUmTw-w" tibex:xpdlId="_BC3KofXzEeuVSY3wUmTw-w"/>
        </bpws:links>
        <bpws:extensionActivity>
            <tibex:receiveEvent createInstance="yes" eventTimeout="0"
                name="Start" tibex:type="startEvent"
                tibex:xpdlId="_TCdgs_RnEeuR8o7qyugDXg" xmlns:tibex="http://www.tibco.com/bpel/2007/extensions">
                <bpws:sources>
                    <bpws:source linkName="Start to _AFLMoPXuEeuVSY3wUmTw-w"/>
                </bpws:sources>
                <tibex:parameters>
                    <parameterDescription mandatory="yes" mode="In" name="PolicyHolder"/>
                    <parameterDescription mode="In" name="PolicyRef"/>
                    <parameterDescription mode="Out" name="ClaimRef"/>
                    <parameterDescription mode="In" name="ClaimId"/>
                    <parameterDescription mode="Out" name="Claim"/>
                </tibex:parameters>
                <tibex:eventSource>
                    <tibex:startEvent eventType="Default"/>
                </tibex:eventSource>
            </tibex:receiveEvent>
        </bpws:extensionActivity>
        <bpws:empty name="End" tibex:type="endEvent" tibex:xpdlId="_TCdgtPRnEeuR8o7qyugDXg">
            <bpws:targets>
                <bpws:target linkName="_BC3KoPXzEeuVSY3wUmTw-w to End"/>
            </bpws:targets>
        </bpws:empty>
        <bpws:empty name="_BX_gateway__AFLMoPXuEeuVSY3wUmTw-w"
            tibex:type="exclusiveGateway" tibex:xpdlId="_AFLMoPXuEeuVSY3wUmTw-w">
            <bpws:targets>
                <bpws:target linkName="Start to _AFLMoPXuEeuVSY3wUmTw-w"/>
            </bpws:targets>
            <bpws:sources tibex:maxTrue="1">
                <bpws:source linkName="_AFLMoPXuEeuVSY3wUmTw-w to GetClaimforPolicy">
                    <bpws:transitionCondition expressionLanguage="urn:tibco:wsbpel:2.0:sublang:javascript"><![CDATA[##otherwise##]]></bpws:transitionCondition>
                </bpws:source>
                <bpws:source linkName="ClaimIdspecified">
                    <bpws:transitionCondition expressionLanguage="urn:tibco:wsbpel:2.0:sublang:javascript"><![CDATA[data.ClaimId != null;]]></bpws:transitionCondition>
                </bpws:source>
            </bpws:sources>
        </bpws:empty>
        <bpws:extensionActivity>
            <tibex:extActivity name="AttempttoGetClaim"
                tibex:type="scriptTask"
                tibex:xpdlId="_XoOAMPXuEeuVSY3wUmTw-w" xmlns:tibex="http://www.tibco.com/bpel/2007/extensions">
                <bpws:targets>
                    <bpws:target linkName="ClaimIdspecified"/>
                </bpws:targets>
                <bpws:sources>
                    <bpws:source linkName="AttempttoGetClaim to VerifyClaim"/>
                </bpws:sources>
                <tibex:script expressionLanguage="urn:tibco:wsbpel:2.0:sublang:javascript"><![CDATA[data.ClaimRef = bpm.caseData.findByCaseIdentifier(data.ClaimId, "com.fnoldata.Claim");

if ( data.ClaimRef != null ) {
	data.Claim = bpm.caseData.read(data.ClaimRef);
	data.debug = "Read Claim";
}]]></tibex:script>
            </tibex:extActivity>
        </bpws:extensionActivity>
        <bpws:empty name="_BX_gateway__BC3KoPXzEeuVSY3wUmTw-w"
            tibex:type="exclusiveGateway" tibex:xpdlId="_BC3KoPXzEeuVSY3wUmTw-w">
            <bpws:targets>
                <bpws:target linkName="ClaimIdisnotvalid to _BC3KoPXzEeuVSY3wUmTw-w"/>
                <bpws:target linkName="Claimisvalid"/>
                <bpws:target linkName="GetClaimforPolicy to _BC3KoPXzEeuVSY3wUmTw-w"/>
            </bpws:targets>
            <bpws:sources>
                <bpws:source linkName="_BC3KoPXzEeuVSY3wUmTw-w to End"/>
            </bpws:sources>
        </bpws:empty>
        <bpws:extensionActivity>
            <tibex:extActivity name="VerifyClaim"
                tibex:type="scriptTask"
                tibex:xpdlId="_DyVooPXzEeuVSY3wUmTw-w" xmlns:tibex="http://www.tibco.com/bpel/2007/extensions">
                <bpws:targets>
                    <bpws:target linkName="AttempttoGetClaim to VerifyClaim"/>
                </bpws:targets>
                <bpws:sources>
                    <bpws:source linkName="VerifyClaim to _Y8PvsPX1EeuVSY3wUmTw-w"/>
                </bpws:sources>
                <tibex:script expressionLanguage="urn:tibco:wsbpel:2.0:sublang:javascript"><![CDATA[if ( data.ClaimRef != null ) {

    // Look up the policy holder for this claim
	data.PolicyRefs.length = 0;
	data.PolicyHolderRefs.length = 0;

	data.PolicyRefs.pushAll( bpm.caseData.navigateAll( data.ClaimRef,"policy", 0, 1) );
	data.PolicyHolderRefs.pushAll( bpm.caseData.navigateAll( data.PolicyRefs[0],"policyholder", 0, 1) );

	if (data.PolicyHolderRefs.length == 0 ) {
		data.ClaimRef = null;
	}
	else {
		data.PolicyHolderRef = data.PolicyHolderRefs[0];
		data.ClaimPolicyHolder = bpm.caseData.read(data.PolicyHolderRef);
		data.debug = "Checking Policy holder";
		
		//Check the policy holder for this claim is the same one that has entered the polcy Id
		if ( data.ClaimPolicyHolder.policyHolderId != data.PolicyHolder.policyHolderId ) {
			data.ClaimRef = null;
			data.debug = "Failed Policy holder check";
		}
	}
}]]></tibex:script>
            </tibex:extActivity>
        </bpws:extensionActivity>
        <bpws:extensionActivity>
            <tibex:extActivity name="ClaimIdisnotvalid"
                tibex:type="userTask"
                tibex:xpdlId="_KreDoPXzEeuVSY3wUmTw-w" xmlns:tibex="http://www.tibco.com/bpel/2007/extensions">
                <bpws:targets>
                    <bpws:target linkName="_Y8PvsPX1EeuVSY3wUmTw-w to ClaimIdisnotvalid"/>
                </bpws:targets>
                <bpws:sources>
                    <bpws:source linkName="ClaimIdisnotvalid to _BC3KoPXzEeuVSY3wUmTw-w"/>
                </bpws:sources>
                <model:PageActivityDataModelType xmi:version="2.0"
                    xmlns:model="http://model.pageactivity.n2.tibco.com" xmlns:xmi="http://www.omg.org/XMI">
                    <pageActivityParameters>
                        <pageActivityParameter mandatory="true"
                            mode="IN" name="ClaimId"/>
                    </pageActivityParameters>
                </model:PageActivityDataModelType>
            </tibex:extActivity>
        </bpws:extensionActivity>
        <bpws:empty name="_BX_gateway__Y8PvsPX1EeuVSY3wUmTw-w"
            tibex:type="exclusiveGateway" tibex:xpdlId="_Y8PvsPX1EeuVSY3wUmTw-w">
            <bpws:targets>
                <bpws:target linkName="VerifyClaim to _Y8PvsPX1EeuVSY3wUmTw-w"/>
            </bpws:targets>
            <bpws:sources tibex:maxTrue="1">
                <bpws:source linkName="_Y8PvsPX1EeuVSY3wUmTw-w to ClaimIdisnotvalid">
                    <bpws:transitionCondition expressionLanguage="urn:tibco:wsbpel:2.0:sublang:javascript"><![CDATA[data.ClaimRef == null;]]></bpws:transitionCondition>
                </bpws:source>
                <bpws:source linkName="Claimisvalid">
                    <bpws:transitionCondition expressionLanguage="urn:tibco:wsbpel:2.0:sublang:javascript"><![CDATA[##otherwise##]]></bpws:transitionCondition>
                </bpws:source>
            </bpws:sources>
        </bpws:empty>
        <bpws:scope name="GetClaimforPolicy"
            tibex:type="reusableSubProcess" tibex:xpdlId="_ZJAHYPX3EeuVSY3wUmTw-w">
            <bpws:targets>
                <bpws:target linkName="_AFLMoPXuEeuVSY3wUmTw-w to GetClaimforPolicy"/>
            </bpws:targets>
            <bpws:sources>
                <bpws:source linkName="GetClaimforPolicy to _BC3KoPXzEeuVSY3wUmTw-w"/>
            </bpws:sources>
            <bpws:sequence name="_BX_sequence">
                <bpws:extensionActivity>
                    <tibex:extActivity
                        name="_BX_SPInput_GetClaimforPolicy" xmlns:tibex="http://www.tibco.com/bpel/2007/extensions">
                        <tibex:script expressionLanguage="urn:tibco:wsbpel:2.0:sublang:javascript"><![CDATA[// Map from 'PolicyRef' to 'PolicyRef'
if (data != null) {
    parameters.PolicyRef = data.PolicyRef;
} else {
    parameters.PolicyRef = null;
}


]]></tibex:script>
                    </tibex:extActivity>
                </bpws:extensionActivity>
                <bpws:extensionActivity>
                    <tibex:extActivity name="GetClaimforPolicy" xmlns:tibex="http://www.tibco.com/bpel/2007/extensions">
                        <tibex:callProcess followParentLifecycle="yes"
                            priority="inline" subProcessId="_ep7ZUPX3EeuVSY3wUmTw-w"/>
                    </tibex:extActivity>
                </bpws:extensionActivity>
                <bpws:extensionActivity>
                    <tibex:extActivity
                        name="_BX_SPOutput_GetClaimforPolicy" xmlns:tibex="http://www.tibco.com/bpel/2007/extensions">
                        <tibex:script expressionLanguage="urn:tibco:wsbpel:2.0:sublang:javascript"><![CDATA[// Map from 'Claim' to 'Claim'
if (parameters != null) {
    data.Claim = parameters.Claim;
} else {
    data.Claim = null;
}

// Map from 'ClaimId' to 'ClaimId'
if (parameters != null) {
    data.ClaimId = parameters.ClaimId;
} else {
    data.ClaimId = null;
}

// Map from 'ClaimRef' to 'ClaimRef'
if (parameters != null) {
    data.ClaimRef = parameters.ClaimRef;
} else {
    data.ClaimRef = null;
}


]]></tibex:script>
                    </tibex:extActivity>
                </bpws:extensionActivity>
            </bpws:sequence>
        </bpws:scope>
    </bpws:flow>
</bpws:process>
